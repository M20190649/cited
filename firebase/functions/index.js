!function(e,t){for(var r in t)e[r]=t[r]}(this,function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("firebase-admin")},function(e,t){e.exports=require("firebase-functions")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("xxhashjs")},function(e,t,r){"use strict";r.r(t);var a=r(0),n=r.n(a),s=r(3),i=r.n(s),o=r(4),c=r.n(o),u=function(e,t,r){if(n.a.isNil(e)||n.a.isNil(t)||n.a.isNil(r))return null;const a=c.a.h64(n.a.toLower((s=r,n.a.trim(n.a.replace(s,/\s+/g," ")))),12).toString(16);var s;return`${n.a.toLower(e)}-${t}-${a}`};async function l({arxiv:e,doi:t,semanticScholar:r}){if(n.a.isNil(e)&&n.a.isNil(t)&&n.a.isNil(r))throw new Error("no id provided");const a=r||(e?`arxiv:${e}`:null)||t;try{return(await i.a.get(`https://api.semanticscholar.org/v1/paper/${a}`)).data}catch(e){if(404===e.response.status)return null;throw e}}function f(e){const t=n.a.property("authors")(e),r=n.a.isArray(t)&&n.a.map(t,e=>(function(e){const t=n.a.split(e," ");return{surname:n.a.last(t),given:n.a.head(t)}})(e.name)),a=n.a.property("[0].surname")(r),s=n.a.toNumber(n.a.property("year")(e)),i=n.a.property("title")(e),o=n.a.property("references")(e),c=n.a.property("citations")(e);return n.a.pickBy({artHash:u(a,s,i),externs:n.a.pickBy({arxiv:n.a.property("arxivId")(e),doi:n.a.property("doi")(e),semanticScholar:n.a.property("paperId")(e)}),title:i,abstract:n.a.property("abstract")(e),year:s,authors:r,venue:n.a.property("venue")(e)&&{name:n.a.property("venue")(e)},nReferences:n.a.isArray(o)&&n.a.size(o),references:n.a.isArray(o)&&n.a.map(o,f),nCitedBys:n.a.isArray(c)&&n.a.size(c),citedBys:n.a.isArray(c)&&n.a.map(c,f)},e=>n.a.isBoolean(e)?e:!n.a.isNil(e))}function d(e){return n.a.pickBy({artHash:e.artHash,externs:e.externs,title:e.title,abstract:e.abstract,authors:e.authors,year:n.a.toNumber(e.year),venue:e.venue,nReference:e.nReference||e.nReferences,referenceArtHashes:n.a.map(e.references,e=>e.artHash),references:n.a.map(n.a.take(e.references,3),p),nCitedBy:e.nCitedBy||e.nCitedBys,citedBys:n.a.map(n.a.take(e.citedBys,3),p)})}function p(e){return n.a.pickBy({artHash:e.artHash,title:e.title,abstract:n.a.truncate(e.abstract,280),firstAuthor:n.a.first(e.authors),year:n.a.toNumber(e.year),venue:e.venue,nReference:e.nReference||e.nReferences,nCitedBy:e.nCitedBy||e.nCitedBys})}function y(e){return{articles:n.a.map(e,m),relations:h(e)}}function h(e){const t=[];return n.a.forEach(e,r=>{n.a.forEach(r.referenceArtHashes,a=>{n.a.forEach(e,e=>{(function(e,t){if(n.a.isNil(e)||n.a.isNil(t))return!1;return!n.a.isEmpty(n.a.intersection(n.a.concat(e),n.a.concat(t)))})(a,e.artHash)&&t.push({reference:b(e),citedBy:b(r)})})})}),t}function m(e){return n.a.pickBy({artHash:b(e),title:n.a.isArray(e.title)?e.title[0]:e.title,abstract:n.a.truncate(e.abstract,{length:280}),year:n.a.toNumber(e.year),firstAuthor:n.a.first(e.authors),venue:e.venue,nReference:e.nReference||e.nReferences,nCitedBy:e.nCitedBy||e.nCitedBys})}function b(e){return n.a.isArray(e.artHash)?e.artHash[0]:e.artHash}var v=r(2),x=r(1);r.d(t,"createUserDoc",(function(){return B})),r.d(t,"deleteUserDoc",(function(){return w})),r.d(t,"onUserDocUpdate",(function(){return H})),r.d(t,"onCollectionDocWrite",(function(){return C})),r.d(t,"onArticleDocWrite",(function(){return g})),r.d(t,"fetchArtBySsId",(function(){return A})),r.d(t,"fetchArtRefColl",(function(){return $})),r.d(t,"fetchSemanticScholar",(function(){return R})),x.initializeApp();const B=v.auth.user().onCreate(async e=>x.firestore().collection("users").doc(e.uid).set({claims:{}})),w=v.auth.user().onDelete(async e=>{(await x.firestore().doc(`users/${e.uid}`).get()).data();return x.firestore().collection("users").doc(e.uid).delete()}),H=v.firestore.document("users/{userId}").onUpdate((e,t)=>{const r=e.after.data(),a=e.before.data();return n.a.isEqual(r.claims,a.claims)?e:x.auth().setCustomUserClaims(t.params.userId,r.claims)}),C=v.firestore.document("collections/{collId}").onWrite(async(e,t)=>{if(!e.after.exists)return x.firestore().doc(`collMetas/${t.params.collId}`).delete();const r=e.after.data();return x.firestore().doc(`collMetas/${t.params.collId}`).set(n.a.pickBy({title:r.title,description:n.a.truncate(r.description,{length:280}),nArticle:n.a.size(r.articles),nEditor:n.a.size(r.editors),owner:r.owner}))}),g=v.firestore.document("articles/{artHash}").onWrite(async(e,t)=>{if(!e.after.exists)return x.firestore().doc(`artMetas/${t.params.artHash}`).delete();const r=e.after.data();return x.firestore().doc(`artMetas/${t.params.artHash}`).set(n.a.pickBy({title:r.title,abstract:n.a.truncate(r.abstract,{length:280}),firstAuthor:n.a.first(r.authors),year:r.year,venue:r.venue,nReference:r.nReference||r.nReferences,nCitedBy:r.nCitedBy||r.nCitedBys}))}),A=v.https.onCall(async(e,t)=>{const r=x.firestore().collection("articles").where("externs.semanticScholar","==",e),a=await r.get();if(!a.empty)return{art:{...a.docs[0].data(),artHash:a.docs[0].id}};const s=f(await l({semanticScholar:e})),i=d(s);return await x.firestore().doc(`articles/${i.artHash}`).set(n.a.omit(i,["artHash"])),{art:i,ssArt:s}}),$=v.https.onCall(async(e,t)=>{const r=await x.firestore().doc(`collections/${e}`).get();if(r.exists)return r.data();const a=await x.firestore().doc(`articles/${e}`).get();if(!a.exists)throw new Error(`article ${e} does not exist!`);const s={...a.data(),artHash:a.id},i=y(await Promise.all(n.a.map(s.referenceArtHashes,async e=>{const t=await x.firestore().doc(`articles/${e}`).get();return t.exists?{...t.data(),artHash:t.id}:null})));return await x.firestore().doc(`collections/${e}`).set(i),i}),R=v.https.onCall(async(e,t)=>{const r=f(await l({semanticScholar:e})),a=await Promise.all(n.a.map(r.references,async e=>f(await l(e.externs)))),s=d(r),i=n.a.map(a,d),o=y(i),c=x.firestore().batch();n.a.forEach([s,...i],e=>{const t=x.firestore().doc(`articles/${e.artHash}`);c.set(t,e)});const u=x.firestore().doc(`collections/${s.artHash}`);return c.set(u,o),await c.commit(),{article:s,collection:o}})}]));